@{ 
    Layout = "_Layout"; 
    ViewBag.Title = "Validation du paiement"; 
} 

<div class="container py-5"> 
    <div class="row"> 
        <div class="col-12"> 
            <div class="d-flex justify-content-between align-items-center mb-4"> 
                <h1 class="h3 mb-0">Validation du paiement</h1> 
                <a asp-controller="Paiement" asp-action="Paiement" class="btn btn-outline-primary"> 
                    <i class="bi bi-arrow-left me-2"></i>Retour au paiement 
                </a> 
            </div> 
        </div> 
    </div> 

    <div class="row"> 
        <!-- Récapitulatif --> 
        <div class="col-lg-8"> 
            <div class="card border-0 shadow-sm mb-4"> 
                <div class="card-body"> 
                    <h5 class="card-title mb-4">Récapitulatif de la commande</h5> 

                    <!-- Informations de paiement --> 
                    <div class="mb-4"> 
                        <h6 class="mb-3">Mode de paiement</h6> 
                        <div class="d-flex align-items-center"> 
                            <i class="bi bi-credit-card text-primary me-2"></i> 
                            <span>Carte bancaire</span> 
                        </div> 
                        <div class="text-muted small mt-1">**** **** **** 4242</div> 
                    </div> 

                    <!-- Produits --> 
                    <div class="mb-4"> 
                        <h6 class="mb-3">Produits commandés</h6> 
                        @if (ViewBag.Items != null) 
                        { 
                            foreach (var item in ViewBag.Items) 
                            { 
                                <div class="d-flex align-items-center mb-2"> 
                                    <img src="@item["Image"]" alt="@item["Nom"]" class="rounded me-2" style="width: 50px; height: 50px; object-fit: cover;"> 
                                    <div class="flex-grow-1"> 
                                        <div>@item["Nom"]</div> 
                                        <div class="text-muted small">@item["Quantite"] x @item["Prix"] €</div> 
                                    </div> 
                                </div> 
                            } 
                        } 
                    </div> 

                    <!-- Total --> 
                    <div class="border-top pt-3"> 
                        <div class="d-flex justify-content-between mb-2"> 
                            <span>Sous-total</span> 
                            <span>@ViewBag.Total €</span> 
                        </div> 
                        <div class="d-flex justify-content-between mb-2"> 
                            <span>Livraison</span> 
                            <span>Gratuit</span> 
                        </div> 
                        <hr> 
                        <div class="d-flex justify-content-between"> 
                            <strong>Total</strong> 
                            <strong class="text-primary">@ViewBag.Total €</strong> 
                        </div> 
                    </div> 

                    <!-- Confirmation --> 
                    <div class="form-check mt-4 mb-4"> 
                        <input class="form-check-input" type="checkbox" id="confirmation" required> 
                        <label class="form-check-label" for="confirmation"> 
                            Je confirme que toutes les informations sont correctes et j'accepte les <a href="#" class="text-decoration-none">conditions générales</a> 
                        </label> 
                    </div> 

                    <button class="btn btn-primary w-100" id="confirmButton" disabled> 
                        <i class="bi bi-check-circle me-2"></i>Confirmer la commande 
                    </button> 
                </div> 
            </div> 
        </div> 

        <!-- Sécurité --> 
        <div class="col-lg-4"> 
            <div class="card border-0 shadow-sm"> 
                <div class="card-body"> 
                    <h5 class="card-title mb-4">Sécurité</h5> 
                    <div class="d-flex align-items-center mb-3"> 
                        <i class="bi bi-shield-check text-primary me-2"></i> 
                        <span>Paiement sécurisé SSL</span> 
                    </div> 
                    <div class="d-flex align-items-center mb-3"> 
                        <i class="bi bi-lock text-primary me-2"></i> 
                        <span>Données cryptées</span> 
                    </div> 
                    <div class="d-flex align-items-center"> 
                        <i class="bi bi-shield-lock text-primary me-2"></i> 
                        <span>Protection contre la fraude</span> 
                    </div> 
                </div> 
            </div> 
        </div> 
    </div> 
</div> 

<!-- Modal de confirmation --> 
<div class="modal fade" id="confirmationModal" tabindex="-1" aria-labelledby="confirmationModalLabel" aria-hidden="true"> 
    <div class="modal-dialog modal-dialog-centered"> 
        <div class="modal-content"> 
            <div class="modal-header"> 
                <h5 class="modal-title" id="confirmationModalLabel">Confirmation du paiement</h5> 
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button> 
            </div> 
            <div class="modal-body text-center"> 
                <div class="mb-4"> 
                    <i class="bi bi-check-circle-fill text-success" style="font-size: 4rem;"></i> 
                </div> 
                <h4 class="mb-3">Paiement réussi !</h4> 
                <p class="mb-4">Votre commande a été validée avec succès. Vous recevrez un email de confirmation dans quelques instants.</p> 
                <div class="d-grid gap-2"> 
                    <a href="@Url.Action("Factures", "Paiement")" class="btn btn-primary"> 
                        <i class="bi bi-receipt me-2"></i>Voir mes factures 
                    </a> 
                    <a href="@Url.Action("Index", "Home")" class="btn btn-outline-primary"> 
                        <i class="bi bi-house me-2"></i>Retour à l'accueil 
                    </a> 
                </div> 
            </div> 
        </div> 
    </div> 
</div> 

@section Scripts { 
    <script> 
        document.addEventListener('DOMContentLoaded', function() { 
            const confirmationCheckbox = document.getElementById('confirmation'); 
            const confirmButton = document.getElementById('confirmButton'); 
            const confirmationModal = new bootstrap.Modal(document.getElementById('confirmationModal')); 

            confirmationCheckbox.addEventListener('change', function() { 
                confirmButton.disabled = !this.checked; 
            }); 

            confirmButton.addEventListener('click', async function() { 
                try { 
                    // Désactiver le bouton pendant le traitement 
                    confirmButton.disabled = true; 
                    confirmButton.innerHTML = '<i class="bi bi-arrow-repeat bi-spin me-2"></i>Création de la session...'; 

                    // Créer la session de paiement Stripe 
                    const response = await fetch('/Paiement/CreateCheckoutSession', { 
                        method: 'POST', 
                        headers: { 
                            'Content-Type': 'application/json' 
                        } 
                    }); 

                    if (!response.ok) { 
                        throw new Error('Erreur lors de la création de la session'); 
                    } 

                    const data = await response.json(); 
                    
                    if (data.url) { 
                        // Rediriger vers la page de paiement Stripe 
                        window.location.href = data.url; 
                    } else { 
                        throw new Error('URL de redirection non trouvée'); 
                    } 
                } catch (error) { 
                    console.error('Erreur:', error); 
                    alert('Une erreur est survenue lors de la création de la session de paiement. Veuillez réessayer.'); 
                    confirmButton.disabled = false; 
                    confirmButton.innerHTML = '<i class="bi bi-check-circle me-2"></i>Confirmer la commande'; 
                } 
            }); 
        }); 
    </script> 
} 